<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Human keyboard</title>
	<script src="../build/tracking-min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="http://ricostacruz.com/jquery.transit/jquery.transit.js"></script>
	<script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"></script>
	<script src="beeplay.min.js"></script>
	<link rel="stylesheet" type="text/css" href="style/style.css">
	<style>
		.rect {
		position: absolute;
		}

		#video {
		position: absolute;
		float: left;
		top: 300px;
		left: 10px;
		}
  </style>
</head>
<body>
	<center>
		<div class="part grey900">
			<h1>Human Keyboard</h1>
		</div>
		<div class="container">
			<div class="part greenA200">
				<p>Video input</p>
			</div>
			<div class="part">
				<div class="input-container">
	        		<video muted autoplay id="video" loop="loop" width="320" height="180"></video>
	        	</div>
        	</div>
		</div>

<div class="holder">
	<center>
	<br><br>
	<div class="playpen">
		<div class="holdball">
			<center>
			<div class="ball" id="ball1"></div>
			<div class="shadow" id="shadow1"></div>
			</center>
		</div>
		<div class="holdball">
			<center>
			<div class="ball" id="ball2"></div>
			<div class="shadow" id="shadow2"></div>
			</center>
		</div>
		<div class="holdball">
			<center>
			<div class="ball" id="ball3"></div>
			<div class="shadow" id="shadow3"></div>
			</center>
		</div>
	</div>

	<div class="piano">
		<span class="whitekey" id="key1">
			<p class="whitename" id="key1name">C</p>
		</span>
		<span class="blackkey" id="key2">
			<p class="blackname" id="key2name">C# <br> D&#9837;
			</p>
		</span>
		<span class="whitekey" id="key3">
			<p class="whitename" id="key3name">D</p>
		</span>
		<span class="blackkey" id="key4">
			<p class="blackname" id="key4name">D# <br> E&#9837;
			</p>
		</span>
		<span class="whitekey" id="key5">
			<p class="whitename" id="key5name">E</p>
		</span>
		<span class="whitekey" id="key6">
			<p class="whitename" id="key6name">F</p>
		</span>
		<span class="blackkey" id="key7">
			<p class="blackname" id="key7name">F# <br> G&#9837;
			</p>
		</span>
		<span class="whitekey" id="key8">
			<p class="whitename" id="key8name">G</p>
		</span>
		<span class="blackkey" id="key9">
			<p class="blackname" id="key9name">G# <br> A&#9837;
			</p>
		</span>
		<span class="whitekey" id="key10">
			<p class="whitename" id="key10name">A</p>
		</span>
		<span class="blackkey" id="key11">
			<p class="blackname" id="key11name">A# <br> B&#9837;
			</p>
		</span>
		<span class="whitekey" id="key12">
			<p class="whitename" id="key12name">B</p>
		</span>
		<span class="whitekey" id="key13">
			<p class="whitename" id="key13name">C</p>
		</span>
		<span class="blackkey" id="key14">
			<p class="blackname" id="key14name">C# <br> D&#9837;
			</p>
		</span>
		<span class="whitekey" id="key15">
			<p class="whitename" id="key15name">D</p>
		</span>
		<span class="blackkey" id="key16">
			<p class="blackname" id="key16name">D# <br> E&#9837;
			</p>
		</span>
		<span class="whitekey" id="key17">
			<p class="whitename" id="key17name">E</p>
		</span>
		<span class="whitekey" id="key18">
			<p class="whitename" id="key18name">F</p>
		</span>
		<span class="blackkey" id="key19">
			<p class="blackname" id="key19name">F# <br> G&#9837;
			</p>
		</span>
		<span class="whitekey" id="key20">
			<p class="whitename"  id="key20name">G</p>
		</span>
		<span class="blackkey" id="key21">
			<p class="blackname" id="key21name">G# <br> A&#9837;
			</p>
		</span>
		<span class="whitekey" id="key22">
			<p class="whitename" id="key22name">A</p>
		</span>
		<span class="blackkey" id="key23">
			<p class="blackname" id="key23name">A# <br> B&#9837;
			</p>
		</span>
		<span class="whitekey" id="key24">
			<p class="whitename" id="key24name">B</p>
		</span>
		<span class="whitekey" id="key25">
			<p class="whitename" id="key25name">C</p>
		</span>
		<span class="blackkey" id="key26">
			<p class="blackname" id="key26name">C# <br> D&#9837;
			</p>
		</span>
		<span class="whitekey" id="key27">
			<p class="whitename" id="key27name">D</p>
		</span>
		<span class="blackkey" id="key28">
			<p class="blackname" id="key28name">D <br> E
			</p>
		</span>
	</div>
	</center>
		<footer>
			<p>Made by Julie Pan and Chelsea Valentine</p>
		</footer>
	</center>
	<script src="script/script.js"></script>
	<script>
		window.onload = function() {
	      trackingInit();
	      CameraInit();
	    }

	    var mediaConstraints = { video: true };
	    var index = 1;
	    var mediaRecorder;
	    var video;
	    var stream;
	    var os_index = 0;
	    var offset = new Array(2);
	    var motion_index;
	    var play_count = 0;

	    function CameraInit() {
	      navigator.getUserMedia(mediaConstraints, onMediaInit, onMediaError);
	    }

	    function startRecording() {

	      video.play();
	      mediaRecorder = new MediaStreamRecorder(stream);
	      mediaRecorder.mimeType = 'video/webm'; // this line is mandatory
	      mediaRecorder.videoWidth  = 320;
	      mediaRecorder.videoHeight = 240;
	      mediaRecorder.ondataavailable = function(blob) {
	        var video = document.getElementById("videodata");
	        video.src = URL.createObjectURL(blob);
	        video.play();
	      };
	      console.log(mediaRecorder);

	      var timeInterval = 600 * 1000;
	      timeInterval = parseInt(timeInterval);
	      // get blob after specific time interval
	      setTimeout(function() {
	        video.pause();
	        mediaRecorder.stop();
	      }, timeInterval);
	      mediaRecorder.start(timeInterval);
	    }

	    //
	    function onMediaInit(Stream) {
	      video = document.getElementById('video');
	      video.src = URL.createObjectURL(Stream);
	      console.log(video);
	      video.height = 240;
	      video.width = 320;
	      video.autoplay = "true";
	      stream = Stream;
	    }

	      function onMediaError(e) {
	        console.error('media error', e);
	      }

	    // below function via: http://goo.gl/B3ae8c
	    function bytesToSize(bytes) {
	     var k = 1000;
	     var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
	     if (bytes === 0) return '0 Bytes';
	     var i = parseInt(Math.floor(Math.log(bytes) / Math.log(k)),10);
	     return (bytes / Math.pow(k, i)).toPrecision(3) + ' ' + sizes[i];
	    }

	    function trackingInit() {
	        var count = 0;
	        var vid = document.getElementById('video');
	        var inputContainer = document.querySelector('.input-container');

	        tracking.ColorTracker.registerColor('green', function(r, g, b) {
	          if (r < 50 && g > 200 && b < 50) {
	            return true;
	          }
	          return false;
	        });

	        tracking.ColorTracker.registerColor('purple', function(r, g, b) {
	          if (r > 120 && g < 10 && b > 120) {
	            return true;
	          }
	          return false;
	        });

	        tracking.ColorTracker.registerColor('red', function(r, g, b) {
	           if (r > 220 && g < 80 && b < 60) {
	            return true;
	            }
	            return false;
	          });

	        var tracker = new tracking.ColorTracker(['magenta', 'cyan', 'red', 'yellow', 'green', 'purple']);

	        tracker.on('track', function(event) {
	          event.data.forEach(function(rect) {
	            if (os_index == 0) {
	              os_index++;
	              offset[os_index] = rect.y;
	            } else {
	              os_index--;
	              offset[os_index] = rect.y;
	            }
	            window.plot(rect.x, rect.y, rect.width, rect.height, rect.color);
	          $(".rect").transition({delay: 1, opacity: 0}, '0');
	          motion_index = Math.abs(offset[1] - offset[0])
	          console.log(rect.color);

	          if (motion_index > 45) {
	            // playSound(rect.color)
	            console.log(play_count)
	            play_count++;
	            if (play_count==2) {
	              playSound(rect.color);
	              play_count = 0;
	            }
	          };

	        });
	      });

	      tracking.track('#video', tracker);


	      window.plot = function(x, y, w, h, color) {
	        var rect = document.createElement('div');
	        document.querySelector('.input-container').appendChild(rect);
	        rect.classList.add('rect');
	        rect.style.border = '2px solid ' + color;
	        rect.style.width = w + 'px';
	        rect.style.height = h + 'px';
	        rect.style.left = (vid.offsetLeft + x) + 'px';
	        rect.style.top = (vid.offsetTop + y) + 'px';
	      };
	    };

	    function playSound(color) {

	      if (color == "cyan") {
	        console.log("cyan played");
	        var a1 = beeplay()
	        .play('C4', 1)
	      } else if (color == "magenta") {
	        console.log("magenta played");
	        var a2 = beeplay()
	        .play('D4', 1)
	      } else if (color == "yellow") {
	        console.log("yellow played");
	        var a3 = beeplay()
	        .play('E4', 1)
	      } else if (color == "purple") {
	        console.log("purple played");
	        var a4 = beeplay()
	        .play('F4', 1)
	      } else if (color == "red") {
	        console.log("red played");
	        var a4 = beeplay()
	        .play('G4', 1)
	      }
	    };
	</script>
</body>
</html>