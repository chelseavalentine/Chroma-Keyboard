<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chroma Keyboard</title>

  <script src="../build/tracking-min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="http://ricostacruz.com/jquery.transit/jquery.transit.js"></script>
  <script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"></script>
  <script src="beeplay.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style/style.css">
  <style>
    .rect {
      position: absolute;
    }

    #video {
      position: relative;

    }
  </style>
</head>
<body>
  
  <div class="part grey900" id="title">
    <h1>Chroma Keyboard</h1>
  </div>
  <div class="subpart">
    <p>Move purple, cyan, magenta, green, red, and yellow objects around in real life, and listen as the music plays!<br><br>
    <em>Note that this works best with screen widths above 1150px</em>
    </p>
  </div>
  <center>
  <span class="left">
    <div class="input-frame">
      <div class="input-container">
        <p>Input camera</p>
        <video muted autoplay id="video" loop="loop" width="320" height="180"></video>
      </div>
    </div>
  </span>
  <div class="holder">
    <center>
    <div class="playpen">
      <div class="holdball">
        <center>
        <div class="ball" id="ball0"></div>
        <div class="shadow" id="shadow0"></div>
        </center>
      </div>
      <div class="holdball">
        <center>
        <div class="ball" id="ball1"></div>
        <div class="shadow" id="shadow1"></div>
        </center>
      </div>
      <div class="holdball">
        <center>
        <div class="ball" id="ball2"></div>
        <div class="shadow" id="shadow2"></div>
        </center>
      </div>
      <div class="holdball">
        <center>
        <div class="ball" id="ball3"></div>
        <div class="shadow" id="shadow3"></div>
        </center>
      </div>
      <div class="holdball">
        <center>
        <div class="ball" id="ball4"></div>
        <div class="shadow" id="shadow4"></div>
        </center>
      </div>
      <div class="holdball">
        <center>
        <div class="ball" id="ball5"></div>
        <div class="shadow" id="shadow5"></div>
        </center>
      </div>
    </div>

    <div class="piano">
      <span class="whitekey" id="key1">
        <p class="whitename" id="key1name">C</p>
      </span>
      <span class="blackkey" id="key2">
        <p class="blackname" id="key2name">C# <br> D&#9837;
        </p>
      </span>
      <span class="whitekey" id="key3">
        <p class="whitename" id="key3name">D</p>
      </span>
      <span class="blackkey" id="key4">
        <p class="blackname" id="key4name">D# <br> E&#9837;
        </p>
      </span>
      <span class="whitekey" id="key5">
        <p class="whitename" id="key5name">E</p>
      </span>
      <span class="whitekey" id="key6">
        <p class="whitename" id="key6name">F</p>
      </span>
      <span class="blackkey" id="key7">
        <p class="blackname" id="key7name">F# <br> G&#9837;
        </p>
      </span>
      <span class="whitekey" id="key8">
        <p class="whitename" id="key8name">G</p>
      </span>
      <span class="blackkey" id="key9">
        <p class="blackname" id="key9name">G# <br> A&#9837;
        </p>
      </span>
      <span class="whitekey" id="key10">
        <p class="whitename" id="key10name">A</p>
      </span>
      <span class="blackkey" id="key11">
        <p class="blackname" id="key11name">A# <br> B&#9837;
        </p>
      </span>
      <span class="whitekey" id="key12">
        <p class="whitename" id="key12name">B</p>
      </span>
      <span class="whitekey" id="key13">
        <p class="whitename" id="key13name">C</p>
      </span>
      <span class="blackkey" id="key14">
        <p class="blackname" id="key14name">C# <br> D&#9837;
        </p>
      </span>
      <span class="whitekey" id="key15">
        <p class="whitename" id="key15name">D</p>
      </span>
      <span class="blackkey" id="key16">
        <p class="blackname" id="key16name">D# <br> E&#9837;
        </p>
      </span>
      <span class="whitekey" id="key17">
        <p class="whitename" id="key17name">E</p>
      </span>
      <span class="whitekey" id="key18">
        <p class="whitename" id="key18name">F</p>
      </span>
      <span class="blackkey" id="key19">
        <p class="blackname" id="key19name">F# <br> G&#9837;
        </p>
      </span>
      <span class="whitekey" id="key20">
        <p class="whitename"  id="key20name">G</p>
      </span>
      <span class="blackkey" id="key21">
        <p class="blackname" id="key21name">G# <br> A&#9837;
        </p>
      </span>
      <span class="whitekey" id="key22">
        <p class="whitename" id="key22name">A</p>
      </span>
      <span class="blackkey" id="key23">
        <p class="blackname" id="key23name">A# <br> B&#9837;
        </p>
      </span>
      <span class="whitekey" id="key24">
        <p class="whitename" id="key24name">B</p>
      </span>
      <span class="whitekey" id="key25">
        <p class="whitename" id="key25name">C</p>
      </span>
      <span class="blackkey" id="key26">
        <p class="blackname" id="key26name">C# <br> D&#9837;
        </p>
      </span>
      <span class="whitekey" id="key27">
        <p class="whitename" id="key27name">D</p>
      </span>
      <span class="blackkey" id="key28">
        <p class="blackname" id="key28name">D <br> E
        </p>
      </span>
    </div>
    </center>
  </div>
</center>

<script src="script/script.js"></script>
<script>
  window.onload = function() {
    trackingInit();
    CameraInit();
  }

  var mediaConstraints = { video: true };
  var index = 1;
  var mediaRecorder;
  var video;
  var stream;
  var os_index = 0;
  var offset = new Array(2);
  var motion_index;
  var play_count = 0;

  function CameraInit() {
    navigator.getUserMedia(mediaConstraints, onMediaInit, onMediaError);
  }

  function startRecording() {

    video.play();
    mediaRecorder = new MediaStreamRecorder(stream);
    mediaRecorder.mimeType = 'video/webm'; // this line is mandatory
    mediaRecorder.videoWidth  = 320;
    mediaRecorder.videoHeight = 240;
    mediaRecorder.ondataavailable = function(blob) {
      var video = document.getElementById("videodata");
      video.src = URL.createObjectURL(blob);
      video.play();
    };
    console.log(mediaRecorder);

    var timeInterval = 600 * 1000;
    timeInterval = parseInt(timeInterval);
    // get blob after specific time interval
    setTimeout(function() {
      video.pause();
      mediaRecorder.stop();
    }, timeInterval);
    mediaRecorder.start(timeInterval);
  }

  //
  function onMediaInit(Stream) {
    video = document.getElementById('video');
    video.src = URL.createObjectURL(Stream);
    console.log(video);
    video.height = 240;
    video.width = 320;
    video.autoplay = "true";
    stream = Stream;
  }

    function onMediaError(e) {
      console.error('media error', e);
    }

  // below function via: http://goo.gl/B3ae8c
  function bytesToSize(bytes) {
   var k = 1000;
   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
   if (bytes === 0) return '0 Bytes';
   var i = parseInt(Math.floor(Math.log(bytes) / Math.log(k)),10);
   return (bytes / Math.pow(k, i)).toPrecision(3) + ' ' + sizes[i];
  }

  function inRange(x, lower, upper) {
     return (x > lower) && (x < upper);
    }
    function trackingInit() {
        var count = 0;
        var vid = document.getElementById('video');
        var inputContainer = document.querySelector('.input-container');
        tracking.ColorTracker.registerColor('green', function(r, g, b) {
          if (inRange(r, 85, 115) &&
          inRange(g, 120, 190) && inRange(b, 80, 150)) {
            return true;
          }
          return false;
        });
        tracking.ColorTracker.registerColor('purple', function(r, g, b) {
          if (inRange(r, 40, 190) && inRange(g, 0, 30) &&  inRange(b, 90, 200)) {
            return true;
          }
          return false;
        });
        tracking.ColorTracker.registerColor('red', function(r, g, b) {
           if (r > 90 && g < 60 && b < 60) {
            return true;
            }
            return false;
          });
        var tracker = new tracking.ColorTracker(['magenta', 'cyan', 'red', 'yellow', 'green', 'purple']);
        tracker.on('track', function(event) {
          event.data.forEach(function(rect) {
            if (os_index == 0) {
              os_index++;
              offset[os_index] = rect.y;
            } else {
              os_index--;
              offset[os_index] = rect.y;
            }
            window.plot(rect.x, rect.y, rect.width, rect.height, rect.color);
          $(".rect").transition({delay: 1, opacity: 0}, '0');
          motion_index = Math.abs(offset[1] - offset[0])
          console.log(rect.color);
          if (motion_index > 45) {
            // playSound(rect.color)
            console.log(play_count)
            play_count++;
            if (play_count==2) {
              playSound(rect.color);
              play_count = 0;
            }
          };
        });
      });
      tracking.track('#video', tracker);
      window.plot = function(x, y, w, h, color) {
        var rect = document.createElement('div');
        document.querySelector('.input-container').appendChild(rect);
        rect.classList.add('rect');
        rect.style.border = '2px solid ' + color;
        rect.style.width = w + 'px';
        rect.style.height = h + 'px';
        rect.style.left = (vid.offsetLeft + x) + 'px';
        rect.style.top = (vid.offsetTop + y) + 'px';
      };
    };

  function yespurple(){
     $("#ball0").transition({
      y: -320
    }, 500)
    .transition({delay: 10, y: 0}, 0)
  }

  function yescyan(){
    $("#ball2").transition({
      y: -320
    }, 500)
    .transition({delay: 10, y: 0}, 0)
  }
  function yesgreen(){
     $("#ball1").transition({
      y: -320
    }, 500)
    .transition({delay: 10, y: 0}, 0)
  }
  function yesmagenta(){
     $("#ball3").transition({
      y: -320
    }, 500)
    .transition({delay: 10, y: 0}, 0)
  }
  function yesred(){
     $("#ball4").transition({
      y: -320
    }, 500)
    .transition({delay: 10, y: 0}, 0)
  }
  function yesyellow(){
     $("#ball5").transition({
      y: -320
    }, 500)
    .transition({delay: 10, y: 0}, 0)
  }

  function playSound(color) {

    if (color == "cyan") {
      // console.log("cyan played");
      var a1 = function(){beeplay()
      .play('C4', 1)};
      yescyan()
    } 

     if (color == "magenta") {
        goMagenta = true;
        // console.log("magenta played");
        var a2 = beeplay()
        .play('D4', 1)
        yesmagenta()
      } 

     if (color == "yellow") {
        goYellow = true;
        // console.log("yellow played");
        var a3 = beeplay()
        .play('E4', 1)
        yesyellow()
      } 

      if (color == "purple") {
        goPurple = true;
        // console.log("purple played");
        var a4 = beeplay()
        .play('F4', 1)
        yespurple()
      } 

      if (color == "green") {
        goGreen = true;
        // console.log("green played");
        var a4 = beeplay()
        .play('G4', 1)
        yesgreen()
      } 

      if (color == "red") {
        goRed = true;
        // console.log("red played");
        var a4 = beeplay()
        .play('A4', 1)
        yesred()
      }
    };

  

</script>
</body>
</html>